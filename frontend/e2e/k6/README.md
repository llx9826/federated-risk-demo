# è”é‚¦é£é™©è¯„ä¼°ç³»ç»Ÿ - K6 å‹åŠ›æµ‹è¯•å¥—ä»¶

æœ¬ç›®å½•åŒ…å«äº†é’ˆå¯¹è”é‚¦é£é™©è¯„ä¼°ç³»ç»Ÿå„ä¸ªæœåŠ¡çš„å®Œæ•´å‹åŠ›æµ‹è¯•å¥—ä»¶ï¼Œä½¿ç”¨ [k6](https://k6.io/) æ€§èƒ½æµ‹è¯•å·¥å…·ã€‚

## ğŸ“‹ æµ‹è¯•æ¦‚è§ˆ

### æœåŠ¡æ¶æ„

```
è”é‚¦é£é™©è¯„ä¼°ç³»ç»Ÿ
â”œâ”€â”€ åŒæ„æœåŠ¡ (Consent Service)     - ç«¯å£ 8000
â”œâ”€â”€ PSIæœåŠ¡ (Private Set Intersection) - ç«¯å£ 8001
â”œâ”€â”€ è®­ç»ƒæœåŠ¡ (Training Service)     - ç«¯å£ 8002
â””â”€â”€ æ¨ç†æœåŠ¡ (Serving Service)      - ç«¯å£ 8003
```

### æµ‹è¯•æ–‡ä»¶

| æµ‹è¯•æ–‡ä»¶ | ç›®æ ‡æœåŠ¡ | ä¸»è¦æµ‹è¯•åœºæ™¯ |
|---------|---------|-------------|
| `consent_stress.js` | åŒæ„æœåŠ¡ | åŒæ„åˆ›å»ºã€æŸ¥è¯¢ã€æ›´æ–°ã€æ’¤é”€ã€å®¡è®¡æ—¥å¿— |
| `psi_stress.js` | PSIæœåŠ¡ | ä¼šè¯åˆ›å»ºã€PSIè®¡ç®—ã€å¥åº·æ£€æŸ¥ |
| `training_stress.js` | è®­ç»ƒæœåŠ¡ | è®­ç»ƒå¯åŠ¨ã€çŠ¶æ€æŸ¥è¯¢ã€æ¨¡å‹æ£€ç´¢ã€è´¨é‡éªŒè¯ |
| `serving_stress.js` | æ¨ç†æœåŠ¡ | å•ä¸ªé¢„æµ‹ã€æ‰¹é‡é¢„æµ‹ã€æ¨¡å‹ä¿¡æ¯æŸ¥è¯¢ |
| `comprehensive_stress.js` | å…¨æœåŠ¡ | è·¨æœåŠ¡åè°ƒã€ç«¯åˆ°ç«¯æµç¨‹ |
| `score_stress.js` | è¯„åˆ†æœåŠ¡ | ç°æœ‰è¯„åˆ†ç›¸å…³æµ‹è¯• |

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å‰ç½®æ¡ä»¶

1. **å®‰è£… k6**
   ```bash
   # macOS
   brew install k6
   
   # å…¶ä»–å¹³å°è¯·å‚è€ƒ: https://k6.io/docs/getting-started/installation/
   ```

2. **å¯åŠ¨æ‰€æœ‰æœåŠ¡**
   ç¡®ä¿ä»¥ä¸‹æœåŠ¡æ­£åœ¨è¿è¡Œ:
   - åŒæ„æœåŠ¡: `http://localhost:8000`
   - PSIæœåŠ¡: `http://localhost:8001`
   - è®­ç»ƒæœåŠ¡: `http://localhost:8002`
   - æ¨ç†æœåŠ¡: `http://localhost:8003`

### è¿è¡Œæµ‹è¯•

#### æ–¹å¼ä¸€: è¿è¡Œæ‰€æœ‰æµ‹è¯• (æ¨è)

```bash
# è¿è¡Œå®Œæ•´çš„å‹åŠ›æµ‹è¯•å¥—ä»¶
./run_all_stress_tests.sh
```

è¿™å°†:
- æ£€æŸ¥æ‰€æœ‰æœåŠ¡çš„å¥åº·çŠ¶æ€
- ä¾æ¬¡è¿è¡Œæ‰€æœ‰å‹åŠ›æµ‹è¯•
- ç”Ÿæˆç»¼åˆæµ‹è¯•æŠ¥å‘Š
- åœ¨ `stress_test_results_YYYYMMDD_HHMMSS/` ç›®å½•ä¸­ä¿å­˜ç»“æœ

#### æ–¹å¼äºŒ: è¿è¡Œå•ä¸ªæµ‹è¯•

```bash
# æµ‹è¯•åŒæ„æœåŠ¡
k6 run consent_stress.js

# æµ‹è¯•PSIæœåŠ¡
k6 run psi_stress.js

# æµ‹è¯•è®­ç»ƒæœåŠ¡
k6 run training_stress.js

# æµ‹è¯•æ¨ç†æœåŠ¡
k6 run serving_stress.js

# æµ‹è¯•å…¨æœåŠ¡åè°ƒ
k6 run comprehensive_stress.js
```

## ğŸ“Š æ€§èƒ½ç›®æ ‡

### åŒæ„æœåŠ¡ (consent_stress.js)
- **å“åº”æ—¶é—´**: 95% < 1500ms
- **é”™è¯¯ç‡**: < 2%
- **åŒæ„æœ‰æ•ˆç‡**: > 95%
- **ç‰¹æ®ŠæŒ‡æ ‡**: å®¡è®¡æ—¥å¿—å®Œæ•´æ€§ã€æ’¤é”€åŠŸèƒ½æ­£å¸¸

### PSIæœåŠ¡ (psi_stress.js)
- **å“åº”æ—¶é—´**: 95% < 3000ms
- **é”™è¯¯ç‡**: < 5%
- **ä¼šè¯æˆåŠŸç‡**: > 90%
- **ç‰¹æ®ŠæŒ‡æ ‡**: å¤„ç†é€Ÿç‡é™åˆ¶ã€è®¡ç®—å‡†ç¡®æ€§

### è®­ç»ƒæœåŠ¡ (training_stress.js)
- **å“åº”æ—¶é—´**: 95% < 5000ms
- **é”™è¯¯ç‡**: < 5%
- **éé€€åŒ–æ¨¡å‹ç‡**: > 80%
- **ç‰¹æ®ŠæŒ‡æ ‡**: è®­ç»ƒå®Œæˆç‡ã€æ¨¡å‹è´¨é‡éªŒè¯

### æ¨ç†æœåŠ¡ (serving_stress.js)
- **å“åº”æ—¶é—´**: 95% < 2000ms
- **é”™è¯¯ç‡**: < 3%
- **é¢„æµ‹æœ‰æ•ˆç‡**: > 90%
- **ç‰¹æ®ŠæŒ‡æ ‡**: ååé‡ã€é¢„æµ‹å‡†ç¡®æ€§

## ğŸ“ˆ æµ‹è¯•é…ç½®

### è´Ÿè½½æ¨¡å¼

æ‰€æœ‰æµ‹è¯•éƒ½é‡‡ç”¨æ¸è¿›å¼è´Ÿè½½æ¨¡å¼:

```javascript
stages: [
  { duration: '30s-1m', target: 5-8 },    // å¯åŠ¨é˜¶æ®µ
  { duration: '2m-3m', target: 20-25 },   // ä¸­ç­‰è´Ÿè½½
  { duration: '4m-5m', target: 50-60 },   // é«˜è´Ÿè½½
  { duration: '3m', target: 30-40 },      // ç¨³å®šè´Ÿè½½
  { duration: '2m', target: 10-15 },      // é™ä½è´Ÿè½½
  { duration: '30s-1m', target: 0 },      // åœæ­¢
]
```

### è‡ªå®šä¹‰æŒ‡æ ‡

æ¯ä¸ªæµ‹è¯•éƒ½åŒ…å«ç‰¹å®šçš„ä¸šåŠ¡æŒ‡æ ‡:

- **é”™è¯¯ç‡** (errors): çœŸæ­£çš„ä¸šåŠ¡é”™è¯¯
- **å“åº”æ—¶é—´** (custom_duration): ç‰¹å®šæ“ä½œçš„è€—æ—¶
- **æˆåŠŸç‡** (success_rate): ä¸šåŠ¡æ“ä½œæˆåŠŸæ¯”ä¾‹
- **è´¨é‡æŒ‡æ ‡** (quality_metrics): æœåŠ¡ç‰¹å®šçš„è´¨é‡åº¦é‡

## ğŸ“‹ æµ‹è¯•æŠ¥å‘Š

### è¾“å‡ºæ–‡ä»¶

è¿è¡Œæµ‹è¯•åï¼Œä¼šç”Ÿæˆä»¥ä¸‹æ–‡ä»¶:

```
stress_test_results_YYYYMMDD_HHMMSS/
â”œâ”€â”€ comprehensive_stress_report.md     # ç»¼åˆæµ‹è¯•æŠ¥å‘Š
â”œâ”€â”€ consent_stress_results.json        # åŒæ„æœåŠ¡è¯¦ç»†æ•°æ®
â”œâ”€â”€ consent_stress_summary.txt         # åŒæ„æœåŠ¡æ‘˜è¦
â”œâ”€â”€ psi_stress_results.json           # PSIæœåŠ¡è¯¦ç»†æ•°æ®
â”œâ”€â”€ psi_stress_summary.txt            # PSIæœåŠ¡æ‘˜è¦
â”œâ”€â”€ training_stress_results.json      # è®­ç»ƒæœåŠ¡è¯¦ç»†æ•°æ®
â”œâ”€â”€ training_stress_summary.txt       # è®­ç»ƒæœåŠ¡æ‘˜è¦
â”œâ”€â”€ serving_stress_results.json       # æ¨ç†æœåŠ¡è¯¦ç»†æ•°æ®
â”œâ”€â”€ serving_stress_summary.txt        # æ¨ç†æœåŠ¡æ‘˜è¦
â””â”€â”€ *_output.log                      # å„æµ‹è¯•çš„æ§åˆ¶å°è¾“å‡º
```

### æŠ¥å‘Šå†…å®¹

æ¯ä¸ªæµ‹è¯•æŠ¥å‘ŠåŒ…å«:

1. **æµ‹è¯•æ¦‚å†µ**: æŒç»­æ—¶é—´ã€è¯·æ±‚æ•°ã€æˆåŠŸç‡ã€é”™è¯¯ç‡
2. **å“åº”æ—¶é—´ç»Ÿè®¡**: å¹³å‡å€¼ã€ä¸­ä½æ•°ã€95%/99%åˆ†ä½æ•°
3. **ä¸šåŠ¡æŒ‡æ ‡**: æœåŠ¡ç‰¹å®šçš„æ€§èƒ½æŒ‡æ ‡
4. **é˜ˆå€¼æ£€æŸ¥**: æ˜¯å¦è¾¾åˆ°é¢„è®¾çš„æ€§èƒ½ç›®æ ‡
5. **ä¼˜åŒ–å»ºè®®**: åŸºäºæµ‹è¯•ç»“æœçš„æ”¹è¿›å»ºè®®

## ğŸ”§ è‡ªå®šä¹‰é…ç½®

### ä¿®æ”¹æµ‹è¯•å‚æ•°

åœ¨å„æµ‹è¯•æ–‡ä»¶çš„ `options` å¯¹è±¡ä¸­è°ƒæ•´:

```javascript
export const options = {
  stages: [
    // ä¿®æ”¹è´Ÿè½½é˜¶æ®µ
  ],
  thresholds: {
    // ä¿®æ”¹æ€§èƒ½é˜ˆå€¼
  },
};
```

### ä¿®æ”¹æœåŠ¡ç«¯ç‚¹

åœ¨å„æµ‹è¯•æ–‡ä»¶é¡¶éƒ¨ä¿®æ”¹æœåŠ¡URL:

```javascript
const SERVICE_URL = 'http://localhost:PORT';
```

### æ·»åŠ è‡ªå®šä¹‰æŒ‡æ ‡

```javascript
import { Counter, Rate, Trend } from 'k6/metrics';

const customMetric = new Counter('custom_metric');
// åœ¨æµ‹è¯•ä¸­ä½¿ç”¨: customMetric.add(1);
```

## ğŸ› æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æœåŠ¡ä¸å¯ç”¨**
   ```
   é”™è¯¯: æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥
   è§£å†³: ç¡®ä¿æ‰€æœ‰æœåŠ¡æ­£åœ¨è¿è¡Œå¹¶å¯è®¿é—®
   ```

2. **é€Ÿç‡é™åˆ¶**
   ```
   é”™è¯¯: HTTP 429 Too Many Requests
   è§£å†³: è°ƒæ•´æµ‹è¯•è´Ÿè½½æˆ–å¢åŠ æœåŠ¡é—´å»¶è¿Ÿ
   ```

3. **å†…å­˜ä¸è¶³**
   ```
   é”™è¯¯: k6 å†…å­˜æº¢å‡º
   è§£å†³: å‡å°‘å¹¶å‘ç”¨æˆ·æ•°æˆ–ç¼©çŸ­æµ‹è¯•æ—¶é—´
   ```

4. **ç½‘ç»œè¶…æ—¶**
   ```
   é”™è¯¯: è¯·æ±‚è¶…æ—¶
   è§£å†³: å¢åŠ è¶…æ—¶æ—¶é—´æˆ–æ£€æŸ¥ç½‘ç»œè¿æ¥
   ```

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   ```bash
   k6 run --verbose test.js
   ```

2. **å‡å°‘è´Ÿè½½æµ‹è¯•**
   ```bash
   k6 run --vus 1 --duration 30s test.js
   ```

3. **æ£€æŸ¥æœåŠ¡æ—¥å¿—**
   æŸ¥çœ‹å„æœåŠ¡çš„æ§åˆ¶å°è¾“å‡ºä»¥è¯†åˆ«é—®é¢˜

## ğŸ“š å‚è€ƒèµ„æ–™

- [k6 å®˜æ–¹æ–‡æ¡£](https://k6.io/docs/)
- [k6 æ€§èƒ½æµ‹è¯•æœ€ä½³å®è·µ](https://k6.io/docs/testing-guides/)
- [è”é‚¦å­¦ä¹ æ€§èƒ½ä¼˜åŒ–æŒ‡å—](https://federated-learning.org/)

## ğŸ¤ è´¡çŒ®

å¦‚éœ€æ·»åŠ æ–°çš„æµ‹è¯•åœºæ™¯æˆ–æ”¹è¿›ç°æœ‰æµ‹è¯•:

1. éµå¾ªç°æœ‰çš„ä»£ç ç»“æ„å’Œå‘½åçº¦å®š
2. æ·»åŠ é€‚å½“çš„é”™è¯¯å¤„ç†å’ŒéªŒè¯
3. æ›´æ–°ç›¸åº”çš„æ–‡æ¡£
4. ç¡®ä¿æµ‹è¯•çš„å¯é‡å¤æ€§å’Œç¨³å®šæ€§

---

*æœ€åæ›´æ–°: $(date '+%Y-%m-%d')*